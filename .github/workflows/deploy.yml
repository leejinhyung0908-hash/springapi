name: Build and Deploy to Docker Hub & EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/springapi
  DOCKER_TAG: latest

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Verify Docker Hub Secrets
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "❌ DOCKERHUB_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "❌ DOCKERHUB_TOKEN secret is not set"
            exit 1
          fi
          echo "✅ Docker Hub secrets are set"
          USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
          TOKEN="${{ secrets.DOCKERHUB_TOKEN }}"
          echo "Username: $USERNAME"
          echo "Token length: ${#TOKEN}"
          echo "Token preview: ${TOKEN:0:10}..."
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE_NAME }}:buildcache,mode=max
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/springall/springapi
            
            # 최신 코드 가져오기 (스크립트 파일 포함)
            git pull origin main || echo "Git pull failed, continuing..."
            
            # 스크립트 파일이 없으면 인라인으로 실행
            if [ -f "scripts/deploy-docker.sh" ]; then
              chmod +x scripts/deploy-docker.sh
              ./scripts/deploy-docker.sh ${{ secrets.DOCKERHUB_USERNAME }}/springapi:${{ github.sha }}
            else
              echo "⚠️  deploy-docker.sh 파일이 없습니다. 인라인 스크립트로 실행합니다..."
              
              DOCKER_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/springapi:${{ github.sha }}"
              CONTAINER_NAME="springapi-container"
              PROJECT_DIR="/home/ubuntu/springall/springapi"
              
              echo "📦 Docker 이미지: $DOCKER_IMAGE"
              
              # Docker 설치 확인
              if ! command -v docker &> /dev/null; then
                echo "📦 Docker를 설치합니다..."
                sudo apt-get update
                sudo apt-get install -y docker.io
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker ubuntu
              fi
              
              # .env 파일 확인
              if [ ! -f "$PROJECT_DIR/.env" ] && [ -f "$PROJECT_DIR/.env.example" ]; then
                cp "$PROJECT_DIR/.env.example" "$PROJECT_DIR/.env"
              fi
              
              # 기존 컨테이너 중지 및 제거
              if [ "$(sudo docker ps -aq -f name=$CONTAINER_NAME)" ]; then
                sudo docker stop $CONTAINER_NAME || true
                sudo docker rm $CONTAINER_NAME || true
              fi
              
              # Docker 이미지 pull
              echo "📥 Docker 이미지를 가져옵니다..."
              sudo docker pull "$DOCKER_IMAGE"
              
              # 새 컨테이너 실행
              echo "▶️  새 컨테이너를 시작합니다..."
              sudo docker run -d \
                --name $CONTAINER_NAME \
                --restart unless-stopped \
                -p 8080:8080 \
                --env-file "$PROJECT_DIR/.env" \
                "$DOCKER_IMAGE"
              
              # 헬스 체크
              echo "🏥 헬스 체크를 수행합니다..."
              MAX_RETRIES=30
              RETRY_COUNT=0
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if curl -f -s "http://localhost:8080/actuator/health" > /dev/null 2>&1; then
                  echo "✅ 헬스 체크 성공!"
                  break
                fi
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "⏳ 헬스 체크 대기 중... ($RETRY_COUNT/$MAX_RETRIES)"
                sleep 2
              done
              
              if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                echo "❌ 헬스 체크 실패!"
                sudo docker logs --tail 50 $CONTAINER_NAME || true
                exit 1
              fi
              
              echo "✅ Docker 배포가 완료되었습니다!"
            fi

